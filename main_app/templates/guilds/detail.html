{% extends 'base.html' %}

{% block content %}
<div class="guild-detail">

  <h1 class="text-3xl font-bold mb-2">{{ guild.name }}</h1>

  {% if guild.description %}
    <p class="mb-4">{{ guild.description }}</p>
  {% endif %}

  <p class="text-sm text-gray-600 mb-6">
    Owned by <strong>{{ guild.owner.display_name }}</strong>
    &middot; Created on {{ guild.created_at|date:"M d, Y" }}
  </p>

  {# ————— Members Section ————— #}
  <section class="mb-8">
    <h2 class="text-2xl font-semibold mb-2">
      Members ({{ guild.members.count }})
    </h2>
    <ul class="list-disc list-inside">
      {% for membership in guild.membership_set.all %}
        <li>
          <a href="{% url 'profile-detail' %}" class="text-blue-600 hover:underline">
            {{ membership.profile.display_name }}
          </a>
          <small class="italic">({{ membership.get_role_display }})</small>
          {% if membership.joined_at %}
            <span class="text-xs text-gray-500">
              joined {{ membership.joined_at|date:"M d, Y" }}
            </span>
          {% endif %}
        </li>
      {% empty %}
        <li>No members have joined this guild yet.</li>
      {% endfor %}
    </ul>

    {% if user.is_authenticated and user.profile != guild.owner %}
      <form action="{% url 'guild-join' guild.pk %}" method="post" class="mt-4">
        {% csrf_token %}
        <button class="px-4 py-2 bg-blue-600 text-white rounded">
          Join Guild
        </button>
      </form>
    {% endif %}
  </section>

  {# ————— "New Event" Button ————— #}
  <p class="mb-4">
    <a href="{% url 'event-create' guild.pk %}"
       class="px-4 py-2 bg-green-600 text-white rounded">
      + Schedule a New Event
    </a>
  </p>

  {# ————— Upcoming Events Section ————— #}
  <section class="mb-8">
    <h2 class="text-2xl font-semibold mb-2">Upcoming Events</h2>

    {% if has_upcoming %}
      <ul class="divide-y divide-gray-200">
        {% for event in upcoming_events %}
          <li class="py-2">
            <button
              class="w-full text-left flex justify-between items-center"
              onclick="document.getElementById('event-{{ event.pk }}').classList.toggle('hidden')"
            >
              <span class="text-lg font-medium text-blue-600 hover:underline">
                {{ event.title }}
              </span>
              <span class="text-sm text-gray-600">
                {{ event.start_time|date:"M d, Y H:i" }}
              </span>
            </button>

            <div id="event-{{ event.pk }}"
                 class="mt-2 hidden border-l-4 border-blue-600 pl-4">
              <p><strong>Ends:</strong> {{ event.end_time|date:"H:i" }}</p>
              {% if event.description %}
                <p><strong>Description:</strong> {{ event.description }}</p>
              {% endif %}
              {% if event.required_roles %}
                <p><strong>Roles Needed:</strong> {{ event.required_roles }}</p>
              {% endif %}
              <p><strong>RSVPs:</strong> {{ event.rsvps.count }}</p>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-500 italic">
        No events are scheduled right now.
        <a href="{% url 'event-create' guild.pk %}" class="text-blue-600 hover:underline">
          Click here to schedule one
        </a>.
      </p>
    {% endif %}
  </section>

  {# ————— Owner Actions ————— #}
  {% if user.is_authenticated and user.profile == guild.owner %}
    <hr class="my-6" />
    <div class="flex space-x-4">
      <a href="{% url 'guild-update' guild.pk %}"
         class="px-4 py-2 bg-green-600 text-white rounded">
        Edit Guild
      </a>
      <form action="{% url 'guild-delete' guild.pk %}"
            method="post"
            onsubmit="return confirm('Really delete this guild?');">
        {% csrf_token %}
        <button type="submit"
                class="px-4 py-2 bg-red-600 text-white rounded">
          Delete Guild
        </button>
      </form>
    </div>
  {% endif %}

</div>
{% endblock %}