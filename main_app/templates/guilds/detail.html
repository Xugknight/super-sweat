{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/guilds/detail.css' %}">
{% endblock %}

{% block content %}
  <div class="page-header">
    <h1>{{ guild.name }}</h1>
  </div>

  {% if guild.description %}
    <p class="page-content">{{ guild.description }}</p>
  {% endif %}

  <p class="page-content">
    <strong>Owned by:</strong> {{ guild.owner.display_name }}<br>
    <strong>Created on:</strong> {{ guild.created_at|date:"M d, Y" }}
  </p>

  <section>
    <h2>Members ({{ approved_members|length }})</h2>
    <ul>
      {% for m in approved_members %}
        <li>
          <a href="{% url 'profile-detail' %}">{{ m.profile.display_name }}</a>
          ({{ m.get_role_display }})
          {% if user.profile == guild.owner %}
            <form action="{% url 'membership-update-role' guild.pk m.pk %}" method="post" style="display:inline">
              {% csrf_token %}
              <select name="role" onchange="this.form.submit()">
                {% for code,label in role_choices %}
                  <option value="{{ code }}"{% if m.role == code %} selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </form>
          {% endif %}
        </li>
      {% empty %}
        <li>No members yet.</li>
      {% endfor %}
    </ul>

    {% if user.is_authenticated and user.profile != guild.owner %}
      {% if is_approved %}
        <form action="{% url 'guild-leave' guild.pk %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn warn">Leave Guild</button>
        </form>
      {% elif is_pending %}
        <p class="page-content">Membership pending approval…</p>
      {% else %}
        <form action="{% url 'guild-join' guild.pk %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn submit">Request to Join</button>
        </form>
      {% endif %}
    {% endif %}
  </section>

  {% if can_manage_events %}
    <section>
      <h2>Pending Requests</h2>
      <ul>
        {% for req in pending_members %}
          <li>
            {{ req.profile.display_name }}
            <form action="{% url 'membership-approve' guild.pk req.pk %}" method="post" style="display:inline">
              {% csrf_token %}
              <button class="btn submit">Approve</button>
            </form>
            <form action="{% url 'membership-reject' guild.pk req.pk %}" method="post" style="display:inline">
              {% csrf_token %}
              <button class="btn danger">Reject</button>
            </form>
          </li>
        {% empty %}
          <li>No pending requests.</li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

<section>
  <h2>Upcoming Events</h2>
    <a href="{% url 'event-create' guild.pk %}" class="btn submit">
        + Schedule Event
    </a>
  {% if has_upcoming %}
    <ul>
      {% for event in upcoming_events %}
        <li>
          <a href="#" onclick="
              document.getElementById('event-{{ event.pk }}')
              .classList.toggle('hidden');
              return false;
          ">
            {{ event.title }} — {{ event.start_time|date:"M d, Y H:i" }}
          </a>
          <div id="event-{{ event.pk }}" class="hidden">
            <p><strong>Ends:</strong> {{ event.end_time|date:"H:i" }}</p>
            {% if event.description %}<p>{{ event.description }}</p>{% endif %}
            {% if event.required_roles %}<p>Roles: {{ event.required_roles }}</p>{% endif %}
            <p>RSVPs: {{ event.rsvps.count }}</p>
            {% if can_manage_events %}
              <a href="{% url 'event-update' event.pk %}" class="btn secondary">Edit</a>
              <form action="{% url 'event-delete' event.pk %}"
                    method="post" style="display:inline">
                {% csrf_token %}
                <button class="btn danger">Delete</button>
              </form>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No upcoming events.</p>
  {% endif %}
</section>

  {% if user.profile == guild.owner %}
    <hr>
    <a href="{% url 'guild-update' guild.pk %}" class="btn secondary">Edit Guild</a>
    <a href="{% url 'guild-delete' guild.pk %}" class="btn danger">Delete Guild</a>
  {% endif %}

</div>
{% endblock %}